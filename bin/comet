#!/usr/bin/env ruby
require 'gli'
require 'yaml'
require 'comet'
require 'helpers'

include GLI::App

program_desc 'Test your Ruby skills! Download Ruby exercises and submit your solutions for grading.'

version Comet::VERSION

desc 'Initialize the current directory as a comet project directory'
skips_pre
command :init do |c|
  c.action do |global_options, options, args|
    answers = Comet::Init.find_config(Dir.pwd) || {}

    ['email', 'token', 'server'].each do |setting|
      answers[setting] = prompt_for_setting(setting, answers)
    end

    Comet::Init.init_project_dir(Dir.pwd, answers)
  end
end

desc 'List the available challenges'
command :list do |c|
  c.action do |global_options,options,args|
    challenges = Comet::Challenge.list(@config)

    if challenges.empty?
      puts "No challenges available."
    else
      sorted_challenges = challenges.sort_by do |challenge|
        [challenge[:topic_name], challenge[:difficulty]]
      end

      sorted_challenges.each do |challenge|
        printf("(%4d) \e[34m%s\e[0m: %s (%s)\n",
          challenge[:id],
          challenge[:topic_name],
          challenge[:name],
          difficulty_to_string(challenge[:difficulty]))
      end
    end
  end
end

desc 'Download a challenge'
command :fetch do |c|
  c.action do |global_options, options, args|
    challenge_id = args.first
    challenge = Comet::Challenge.find(@config, challenge_id)
    directory = challenge.download

    info = { 'id' => challenge_id.to_i, 'file_name' => "#{challenge.slug}.rb" }
    info_file = File.join(directory, '.challenge')
    File.write(info_file, info.to_yaml)
  end
end

desc 'Submit challenge'
command :submit do |c|
  c.action do |global_options, options, args|
    require 'rest_client'
    require 'tmpdir'

    current_dir = Dir.pwd
    challenge_file = File.join(current_dir, '.challenge')

    if File.exists?(challenge_file)
      challenge_info = YAML.load(File.read(challenge_file))
      lib_dir = File.join(current_dir, 'lib')

      Dir.mktmpdir do |tmpdir|
        submission_file = File.join(tmpdir, 'submission.tar.gz')
        if system("tar zcf #{submission_file} -C #{lib_dir} .")
          payload = {
            submission: {
              challenge_id: challenge_info['id'],
              archive: File.new(submission_file)
            }
          }

          headers = { 'Authorization' => "Token #{@config['token']}" }

          RestClient.post("#{@config['server']}/api/v1/submissions.json", payload, headers)
        else
          puts "Unable to create submission archive."
          exit 1
        end
      end

    else
      puts "Not a challenge directory."
      exit 1
    end
  end
end

pre do |global,command,options,args|
  @config = Comet::Init.find_config(Dir.pwd)
  !@config.nil?
end

post do |global,command,options,args|
  # Post logic here
  # Use skips_post before a command to skip this
  # block on that command only
end

on_error do |exception|
  # Error logic here
  # return false to skip default error handling
  raise exception
end

exit run(ARGV)
